name: Deploy BriefFlow to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  HOST: ${{ secrets.HOST }}
  PORT: 5001

jobs:
  deploy:
    name: Deploy to VPS via SSH
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add host to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy to VPS
        run: |
          echo "ðŸš€ Starting deployment to VPS..."
          echo "ðŸ“Œ Host: ${{ secrets.HOST }}"
          echo "ðŸ‘¤ User: ${{ secrets.SSH_USER }}"
          echo ""
          
          # Deploy via SSH with proper error handling
          ssh -o ConnectTimeout=30 -o ServerAliveInterval=15 -o ServerAliveCountMax=4 ${{ secrets.SSH_USER }}@${{ secrets.HOST }} << 'ENDSSH'
            set -e
            set -x
            
            echo "ðŸ“‚ Navigating to /opt/brieflow..."
            cd /opt/brieflow || {
              echo "âŒ ERROR: Directory /opt/brieflow not found!"
              exit 1
            }
            
            echo "âœ… Directory found: $(pwd)"
            echo ""
            
            echo "ðŸ” Checking git configuration..."
            echo "=== Current Git Remotes ==="
            git remote -v
            
            echo ""
            echo "=== Checking and creating remotes ==="
            if git remote | grep -q "^github$"; then
              echo "âœ… Remote 'github' exists"
            else
              echo "âš ï¸  Remote 'github' not found, creating..."
              git remote add github git@github.com:Gabrielloopes33/brieflow.git
              echo "âœ… Remote 'github' created"
            fi
            
            if git remote | grep -q "^origin$"; then
              echo "âœ… Remote 'origin' exists"
            else
              echo "âš ï¸  Remote 'origin' not found, creating..."
              git remote add origin git@github.com:Gabrielloopes33/brieflow.git
              echo "âœ… Remote 'origin' created"
            fi
            
            echo ""
            echo "ðŸ“¥ Attempting git pull from origin..."
            
            # Function to retry git pull with timeout
            attempt_pull() {
              local max_attempts=3
              local attempt=1
              
              echo "ðŸ”„ Attempting git pull (max $max_attempts attempts)..."
              while [ $attempt -le $max_attempts ]; do
                echo "ðŸ“ Attempt $attempt of $max_attempts..."
                
                if timeout 90 git pull origin main 2>&1; then
                  echo "âœ… Git pull successful!"
                  return 0
                else
                  local exit_code=$?
                  echo "âŒ Attempt $attempt failed with exit code: $exit_code"
                  
                  if [ $attempt -lt $max_attempts ]; then
                    echo "â³ Waiting 10 seconds before retry..."
                    sleep 10
                    attempt=$((attempt + 1))
                  else
                    echo "âŒ All $max_attempts attempts failed"
                    return 1
                  fi
                fi
              done
            }
            
            # Execute pull with retry
            if attempt_pull; then
              echo "âœ… Code updated successfully"
            else
              echo "âŒ Failed to pull code after $max_attempts attempts"
              exit 1
            fi
            
            echo ""
            echo "ðŸ”¨ Checking if deploy script exists..."
            if [ -f vps-deploy.sh ]; then
              echo "âœ… Deploy script found"
              chmod +x vps-deploy.sh
            else
              echo "âŒ ERROR: vps-deploy.sh not found!"
              echo "ðŸ“‹ Contents of /opt/brieflow:"
              ls -la
              exit 1
            fi
            
            echo ""
            echo "ðŸ— Executing deploy script..."
            ./vps-deploy.sh all
            
            echo ""
            echo "âœ… Deployment completed successfully!"
          ENDSSH
          
      - name: Wait for services to start
        run: |
          echo "â³ Waiting 20 seconds for services to start..."
          sleep 20
          
      - name: Health Check
        id: health_check
        run: |
          echo "ðŸ” Running health check..."
          echo "ðŸ“Œ Host: ${{ secrets.HOST }}:$PORT"
          echo ""
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "ðŸ”„ Health check attempt $RETRY_COUNT/$MAX_RETRIES..."
            
            # Test both HTTP and health endpoint
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.HOST }}:$PORT/ || echo "000")
            HEALTH_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.HOST }}:$PORT/api/health || echo "000")
            
            echo "   HTTP code: $HTTP_CODE, Health code: $HEALTH_CODE"
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
              echo "âœ… Application is responding on HTTP port!"
              echo "health_ok=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            if [ "$RETRY_COUNT" -lt "$MAX_RETRIES" ]; then
              echo "â³ Attempt $RETRY_COUNT failed, waiting 10 seconds..."
              sleep 10
            fi
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          echo "   HTTP code: $HTTP_CODE"
          echo "   Health code: $HEALTH_CODE"
          echo ""
          echo "ðŸ“‹ Troubleshooting steps:"
          echo "   1. Check if containers are running: ssh ${{ secrets.SSH_USER }}@${{ secrets.HOST }} 'docker ps'"
          echo "   2. View application logs: ssh ${{ secrets.SSH_USER }}@${{ secrets.HOST }} 'docker logs brielflow-app --tail=100'"
          echo "   3. Check if port $PORT is open: curl http://${{ secrets.HOST }}:$PORT"
          echo "health_ok=false" >> $GITHUB_OUTPUT
          exit 1
          
      - name: Get Container Status (on failure)
        if: failure()
        run: |
          echo "ðŸ“‹ Getting container status from VPS..."
          ssh -o ConnectTimeout=15 ${{ secrets.SSH_USER }}@${{ secrets.HOST }} << 'ENDSSH'
            set -x
            echo "=== Docker Container Status ==="
            docker ps -a
            
            echo ""
            echo "=== Recent Application Logs ==="
            docker logs brielflow-app --tail=50 || echo "Container brielflow-app not found"
            
            echo ""
            echo "=== System Information ==="
            df -h | head -5
            free -h
          ENDSSH
          
      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Deploy completed successfully!"
          echo ""
          echo "ðŸŒ Application is running at:"
          echo "   Frontend: http://${{ secrets.HOST }}:$PORT"
          echo "   API: http://${{ secrets.HOST }}:$PORT/api"
          echo "   Health: http://${{ secrets.HOST }}:$PORT/api/health"
          echo ""
          echo "ðŸ“Š You can monitor the application at the URL above."
          
      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Deploy failed!"
          echo ""
          echo "ðŸ“Š Summary:"
          echo "   âœ… SSH connection: Connected"
          echo "   âŒ Deployment: FAILED"
          echo ""
          echo "ðŸ”§ Troubleshooting steps:"
          echo "   1. Check GitHub Secrets (SSH_PRIVATE_KEY, HOST, SSH_USER)"
          echo "   2. Verify SSH keys on VPS: cat ~/.ssh/authorized_keys"
          echo "   3. Test SSH manually: ssh ${{ secrets.SSH_USER }}@${{ secrets.HOST }}"
          echo "   4. Check deployment logs above"
          echo "   5. Verify service is running: ssh ${{ secrets.SSH_USER }}@${{ secrets.HOST }} 'docker ps'"
