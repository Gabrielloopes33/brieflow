name: Deploy BriefFlow to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS via SSH
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add host to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy to VPS
        run: |
          echo "ðŸš€ Iniciando deploy no VPS..."
          
          ssh ${{ secrets.SSH_USER }}@${{ secrets.HOST }} << 'EOF'
            set -e
            
            echo "ðŸ“‚ Navegando para /opt/brieflow..."
            cd /opt/brieflow
            
            echo "ðŸ“¥ Fazendo git pull..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "ðŸ”„ Atualizando serviÃ§o Docker Swarm..."
            # ForÃ§a recriaÃ§Ã£o do container com novo cÃ³digo
            docker service update --force brielflow_app
            
            echo "â³ Aguardando serviÃ§o iniciar..."
            sleep 30
            
            echo "âœ… Deploy concluÃ­do!"
          EOF
          
      - name: Health Check
        run: |
          echo "ðŸ” Verificando se aplicaÃ§Ã£o estÃ¡ rodando..."
          sleep 10
          
          # Tenta acessar o health endpoint 3 vezes
          for i in 1 2 3; do
            response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.HOST }}:5001/api/health || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "âœ… AplicaÃ§Ã£o estÃ¡ saudÃ¡vel!"
              exit 0
            fi
            
            echo "â³ Tentativa $i falhou, aguardando..."
            sleep 10
          done
          
          echo "âŒ Health check falhou apÃ³s 3 tentativas"
          exit 1
          
      - name: Notify on Failure
        if: failure()
        run: |
          echo "âŒ Deploy falhou! Verifique os logs na VPS:"
          echo "   ssh ${{ secrets.SSH_USER }}@${{ secrets.HOST }}"
          echo "   docker service logs briefflow_app"
