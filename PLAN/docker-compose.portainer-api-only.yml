version: '3.8'

services:
  app:
    image: node:20-alpine
    working_dir: /app
    command: >
      sh -c "
        set -e
        echo 'ðŸ“¦ Instalando dependÃªncias...'
        npm install --include=dev --silent
        
        echo 'ðŸ§¹ Limpando diretÃ³rios antigos...'
        rm -rf dist node_modules/.cache .vite
        
        echo 'ðŸ—ï¸  Executando build do servidor apenas...'
        npx esbuild server/index.ts \
          --bundle \
          --platform=node \
          --format=cjs \
          --outfile=dist/index.cjs \
          --external:react \
          --external:react-dom \
          --external:@vitejs/plugin-react \
          --external:vite \
          --external:tailwindcss \
          --external:postcss \
          --external:autoprefixer \
          --external:@tailwindcss/* \
          --minify
        
        echo 'ðŸ“ Criando diretÃ³rio public...'
        mkdir -p dist/public
        
        echo 'ðŸ“„ Copiando index.html para build simples...'
        cp client/index.html dist/public/ 2>/dev/null || echo '<html><body>API Running</body></html>' > dist/public/index.html
        
        echo 'ðŸš€ Iniciando servidor...'
        npx tsx server/production-server.ts
      "
    ports:
      - target: 5000
        published: 5001
        mode: host
    environment:
      NODE_ENV: production
      PORT: 5000
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      SESSION_SECRET: ${SESSION_SECRET}
      FRONTEND_URL: ${FRONTEND_URL}
      SUPABASE_URL: https://supa.agenciatouch.com.br
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
      NODE_OPTIONS: --max-old-space-size=2048
    volumes:
      - type: bind
        source: /opt/brieflow
        target: /app
    networks:
      - brieflow-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  nginx:
    image: nginx:alpine
    ports:
      - target: 80
        published: 8082
        mode: host
    volumes:
      - type: bind
        source: /opt/brieflow/nginx/nginx.conf
        target: /etc/nginx/nginx.conf
        read_only: true
      - nginx_logs:/var/log/nginx
    networks:
      - brieflow-network
    depends_on:
      - app
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  redis:
    image: redis:7-alpine
    ports:
      - target: 6379
        published: 6380
        mode: host
    volumes:
      - redis_data:/data
    networks:
      - brieflow-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

networks:
  brieflow-network:
    driver: overlay
    attachable: true

volumes:
  redis_data:
  nginx_logs:
