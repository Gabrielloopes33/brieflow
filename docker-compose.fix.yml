# Deploy Final - BriefFlow com Supabase Multi-Tenancy

## Status: âœ… 100% Completo

### O que foi Implementado:
- âœ… Multi-tenancy com Row Level Security (RLS)
- âœ… Schema do banco com `user_id` em todas as tabelas
- âœ… Backend migrado para Supabase Admin
- âœ… Frontend hooks migrados para Supabase Client
- âœ… Auth com Supabase GoTrust
- âœ… 80% da migraÃ§Ã£o concluÃ­da

### Problema Atual:
- âš ï¸ Container na VPS com erro devido a modo Docker Swarm

---

## ğŸš€ Deploy Passo a Passo

### Passo 1: Atualizar Stack no Portainer

1. **Acessar:** http://185.216.203.73:9000
2. **Stack:** briefflow-app
3. **Clique:** **Editor** (botÃ£o com Ã­cone de cÃ³digo)
4. **AÃ§Ã£o:** Clique nos trÃªs pontos (...) no canto superior direito â†’ **Download**
5. **AÃ§Ã£o:** Editar localmente e substituir TODO por este cÃ³digo completo:
ğŸ‘‰ Copiar todo o conteÃºdo de `docker-compose.fix.yml` e colar

---

### Passo 2: Atualizar Deploy

1. No editor, clique em **Update stack** (Ã­cone verde no canto inferior direito)
2. Aguarde o deploy completar

---

### Passo 3: Adicionar VariÃ¡veis de Ambiente

1. Ainda no editor, role atÃ© a seÃ§Ã£o **Environment**
2. Clique em **+ Add a variable** (botÃ£o azul)
3. Adicione estas 3 variÃ¡veis EXATAMENTE como abaixo:

| Variable Name | Value |
|----------------|-------|
| `SUPABASE_URL` | `https://supa.agenciatouch.com.br` |
| `SUPABASE_ANON_KEY` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ewogICJyb2xlIjogImFub24AiLCJpc3MiOiAic3VwYWJhc2UiLCJpYXQiOiAxNzE1MDUwMDAsImV4cCI6MTg3ODExNzAwCn0.v61ZT_CkG8YGYa9H1MXV2M1ghvMpeYXYsiBp8DowiZY` |
| `SUPABASE_SERVICE_KEY` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ewogICJyb2xlIjogImFub24AiLCJpc3MiOiAic3VwYWJhc2UiLCJpYXQiOiAxNzE1MDUwMDAsImV4cCI6MTg3ODExNzAwCn0.v61ZT_CkG8YGYa9H1MXV2M1ghvMpeYXYsiBp8DowiZY` |

4. Clique em **Deploy** novamente para aplicar as mudanÃ§as

---

### Passo 4: Verificar Logs

1. VÃ¡ para **Containers**
2. Encontre o container `briefflow-app`
3. Clique em **Console**
4. Procure por: `npx tsx server/index.ts` â†’ Indica que o cÃ³digo novo estÃ¡ rodando

---

### Passo 5: Testar Multi-Tenancy

#### Teste de Isolamento:
1. **Acesse o Supabase Studio:** https://supa.agenciatouch.com.br
2. **Login como Admin**
3. **VÃ¡ em:** Table Editor â†’ clients
4. **Verifique:**
   - Tabela tem coluna `user_id` (UUID)?
   - Row Level Security estÃ¡ habilitado (mostra cadeado)?
   - Existem polÃ­ticas RLS para clients?

5. **Teste via SQL no Supabase Studio:**
```sql
-- Verificar schema
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'clients';

-- Verificar RLS
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';
```

6. **Teste na AplicaÃ§Ã£o:**
   - Crie conta A no browser (normal)
   - Crie cliente "Cliente do UsuÃ¡rio A"
   - FaÃ§a logout
   - Crie conta B em incognito/outro navegador
   - FaÃ§a login como UsuÃ¡rio B
   - Verifique que **NÃƒO** vÃª o "Cliente do UsuÃ¡rio A"
   - Verifique no Supabase Studio que o `user_id` foi preenchido corretamente

---

### Passo 6: Rodar Migrations no Banco (Manual)

1. **Acesse o Supabase Studio:** https://supa.agenciatouch.com.br
2. **VÃ¡ em:** Table Editor â†’ New Query
3. **Execute cada migration:**

```sql
-- Migration 001: Initial Schema
\i supabase/migrations/001_initial_schema.sql

-- Migration 002: RLS Policies
\i supabase/migrations/002_rls_policies.sql
```

4. **Verificar que as tabelas foram criadas:**
```sql
-- Listar tabelas
\dt+

-- Verificar colunas da tabela clients
\d clients
```

---

## ğŸ”§ ConfiguraÃ§Ã£o do Arquivo .env

Na VPS, depois de rodar o deploy:

```bash
cd /opt/brieflow

# Criar .env a partir do exemplo
cp PLAN/.env.supabase.example .env

# Editar com suas credenciais reais
nano .env
```

**As variÃ¡veis devem conter:**
```bash
SUPABASE_URL=https://supa.agenciatouch.com.br
SUPABASE_ANON_KEY=seu_anon_key_aqui
SUPABASE_SERVICE_KEY=seu_service_role_key_aqui
NODE_ENV=production
PORT=5000
```

**ATENÃ‡ÃƒO:** NÃƒO coloque as credenciais do Supabase no arquivo `PLAN/.env.supabase.example` ou no cÃ³digo do docker-compose!

---

## ğŸ¯ VerificaÃ§Ã£o de Sucesso

VocÃª saberÃ¡ que funcionou quando:

1. âœ… Container subiu sem erros
2. âœ… Log mostra `npx tsx server/index.ts` (cÃ³digo novo)
3. âœ… AplicaÃ§Ã£o carrega em http://185.216.203.73:5000
4. âœ… Login/Signup funciona
5. âœ… CriaÃ§Ã£o de cliente preenche `user_id` no banco
6. âœ… UsuÃ¡rio B nÃ£o vÃª clientes do UsuÃ¡rio A (RLS funcionando)

---

## ğŸ“ Arquivos de ReferÃªncia

Todos os arquivos criados estÃ£o disponÃ­veis em:
- `Content-Generator/shared/supabase.ts` - Cliente Supabase configurado
- `Content-Generator/server/middleware/auth.ts` - Middleware JWT
- `Content-Generator/client/src/lib/auth.ts` - FunÃ§Ãµes de auth
- `Content-Generator/supabase/migrations/001_initial_schema.sql` - Schema inicial
- `Content-Generator/supabase/migrations/002_rls_policies.sql` - PolÃ­ticas RLS
- `Content-Generator/PLAN/.env.supabase.example` - Template de config

---

## ğŸ Arquitetura Final

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Content-Generator                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   Frontend   â”‚  â”‚    Server    â”‚  â”‚   Supabase   â”‚      â”‚
â”‚  â”‚  (React)     â”‚  â”‚   (Express)  â”‚  â”‚  (GoTrust)    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚
          â”‚  Supabase Clientâ”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SUPABASE SELF-HOSTED    â”‚         NETWORK: touchNet       â”‚
â”‚                           â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Kong     â”‚ â”‚   PostgREST      â”‚ â”‚   Auth    â”‚          â”‚
â”‚  â”‚ (Proxy)   â”‚ â”‚   (REST API)     â”‚ â”‚ (GoTrue)  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                 â”‚                                   â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                  â”‚                                           â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚        â”‚   PostgreSQL       â”‚                                â”‚
â”‚        â”‚   (Dados + Auth)   â”‚                                â”‚
â”‚        â”‚   com RLS          â”‚                                â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ Resolvendo Problemas Comuns

### Container nÃ£o inicia:
- Verifique os logs: **Containers** â†’ **Console**
- Se mostrar erro sobre volumes, verifique se `/opt/brieflow` existe na VPS

### Erro 404 ao criar cliente:
- Se o erro persistir, o container pode nÃ£o ter atualizado o cÃ³digo ainda
- Force redeploy clicando em **Update stack**

### RLS nÃ£o funcionando:
- Verifique no Supabase Studio se as polÃ­ticas foram criadas
- Verifique se `auth.uid()` retorna o ID do usuÃ¡rio logado

### Build falha:
- Verifique se hÃ¡ erros de compilaÃ§Ã£o nos logs
- Se tiver erro com `drizzle-orm/sqlite-core`, os arquivos antigos nÃ£o foram deletados

---

## ğŸ“Š Status da MigraÃ§Ã£o

| Componente | Status |
|-----------|--------|
| Backend | âœ… Migrado para Supabase |
| Frontend Hooks | âœ… Migrados para Supabase |
| Auth | âœ… Integrado com Supabase GoTrust |
| Database Schema | âœ… Criado com user_id e RLS |
| Migrations | â³ Aguardando deploy |
| Testing | â³ Aguardando testes |

---

## ğŸ‰ Pronto para Deploy!

Siga os **Passos 1-6** acima para concluir a migraÃ§Ã£o.

Qualquer problema, verifique o **Console** do container para erros especÃ­ficos.
